'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _axios=require('axios'),_axios2=_interopRequireDefault(_axios),_fs=require('fs'),_fs2=_interopRequireDefault(_fs),_utils=require('./utils'),_upload_result=require('./upload_result'),_upload_result2=_interopRequireDefault(_upload_result),_error=require('./error'),_error2=_interopRequireDefault(_error);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}class Client{constructor(a){this.api=a,this.defaultHeader={"User-Agent":a.userAgent,"Content-Type":'application/x-www-form-urlencoded',Accept:'application/json'}}get(a,b={},c=null){const d={method:'get',url:this.url(a),headers:this.defaultHeader,params:b,timeout:1e3*c,proxy:this.api.proxy};return(0,_axios2.default)(d).then(a=>a.data).catch(a=>Client.handleError(a))}post(a,b,c=null){const d={method:'post',url:this.url(a),headers:this.defaultHeader,data:(0,_utils.buildQueryString)(b),timeout:1e3*c,proxy:this.api.proxy};return(0,_axios2.default)(d).then(a=>a.data).catch(a=>Client.handleError(a))}download(a,b){var c=this;return _asyncToGenerator(function*(){const d={url:a,timeout:1e3*c.api.downloadTimeout,proxy:c.api.proxy,responseType:'stream'},e=yield(0,_axios2.default)(d).catch(function(a){return Client.handleError(a)});return e.data.pipe(_fs2.default.createWriteStream(b)),new Promise(function(a,c){e.data.on('end',function(){a(b)}),e.data.on('error',function(a){c(new _error2.default(a))})})})()}upload(a,b){const c=encodeURIComponent(b),d=Object.assign({"Content-Type":'application/octet-stream',"Content-Disposition":`attachment; filename*=UTF-8''${c}`},this.defaultHeader),e={method:'post',url:this.url('upload'),headers:d,data:a,maxContentLength:1/0,timeout:1e3*this.api.uploadTimeout,proxy:this.api.proxy};return(0,_axios2.default)(e).then(a=>new _upload_result2.default(a.data)).catch(a=>Client.handleError(a))}url(a){return`${this.api.baseUri}/${a}?secret=${this.api.secret}`}static handleError(a){let b;throw a.response&&a.response.data&&(b=a.response.data),new _error2.default(a,b)}}exports.default=Client,module.exports=exports['default'];